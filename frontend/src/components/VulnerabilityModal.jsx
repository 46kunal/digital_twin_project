import React, { useEffect, useState } from 'react';
import api from '../services/api';

export default function VulnerabilityModal({ scanId, onClose }) {
  const [vulns, setVulns] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    api.get(`/api/scan/${scanId}/vulnerabilities`)
      .then(res => {
        setVulns(res.data);
        setLoading(false);
      })
      .catch(err => {
        console.error('Failed to load vulnerabilities:', err);
        setLoading(false);
      });
  }, [scanId]);

  const getSeverityColor = (severity) => {
    if (!severity) return '#666';
    const s = severity.toLowerCase();
    if (s.includes('crit')) return '#d32f2f';
    if (s.includes('high')) return '#ff4444';
    if (s.includes('medium')) return '#ff9800';
    if (s.includes('low')) return '#ffc107';
    return '#666';
  };

  return (
    <div style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0,0,0,0.8)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 1000
    }}>
      <div style={{
        background: '#1e1e1e',
        padding: 30,
        borderRadius: 8,
        maxWidth: '90%',
        maxHeight: '90%',
        overflow: 'auto',
        color: '#fff',
        minWidth: 600
      }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 20 }}>
          <h2>Scan #{scanId} - Vulnerabilities</h2>
          <button 
            onClick={onClose}
            style={{
              background: '#ff4444',
              color: '#fff',
              border: 'none',
              padding: '8px 16px',
              borderRadius: 4,
              cursor: 'pointer'
            }}
          >
            Close
          </button>
        </div>

        {loading ? (
          <p>Loading vulnerabilities...</p>
        ) : vulns.length === 0 ? (
          <p style={{ color: '#666' }}>No vulnerabilities found for this scan.</p>
        ) : (
          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
            <thead>
              <tr style={{ background: '#2a2a2a' }}>
                <th style={{ padding: 10, textAlign: 'left' }}>CVE ID</th>
                <th style={{ padding: 10, textAlign: 'left' }}>Severity</th>
                <th style={{ padding: 10, textAlign: 'center' }}>CVSS</th>
                <th style={{ padding: 10, textAlign: 'center' }}>Port</th>
                <th style={{ padding: 10, textAlign: 'left' }}>Service</th>
                <th style={{ padding: 10, textAlign: 'left' }}>Description</th>
              </tr>
            </thead>
            <tbody>
              {vulns.map(v => (
                <tr key={v.id} style={{ borderTop: '1px solid #333' }}>
                  <td style={{ padding: 10 }}>
                    {v.cve_id ? (
                      <a 
                        href={`https://nvd.nist.gov/vuln/detail/${v.cve_id}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        style={{ color: '#0066cc' }}
                      >
                        {v.cve_id}
                      </a>
                    ) : (
                      <span style={{ color: '#666' }}>N/A</span>
                    )}
                  </td>
                  <td style={{ padding: 10 }}>
                    <span style={{
                      padding: '4px 8px',
                      background: getSeverityColor(v.severity),
                      borderRadius: 4,
                      fontSize: 12
                    }}>
                      {v.severity || 'Unknown'}
                    </span>
                  </td>
                  <td style={{ padding: 10, textAlign: 'center' }}>
                    {v.cvss_score ? v.cvss_score.toFixed(1) : '-'}
                  </td>
                  <td style={{ padding: 10, textAlign: 'center' }}>
                    {v.port || '-'}
                  </td>
                  <td style={{ padding: 10 }}>{v.service || '-'}</td>
                  <td style={{ padding: 10, fontSize: 12, color: '#aaa' }}>
                    {v.description ? v.description.substring(0, 100) + '...' : '-'}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}
